# SkillSync CI Pipeline
# Runs on pull requests to master/main
# Builds and tests all microservices

name: CI Pipeline

on:
  pull_request:
    branches: [master, main]
  push:
    branches: [master, main]

env:
  NODE_VERSION: '20'

jobs:
  # Detect which services changed
  changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      course: ${{ steps.filter.outputs.course }}
      learning: ${{ steps.filter.outputs.learning }}
      payment: ${{ steps.filter.outputs.payment }}
      nginx: ${{ steps.filter.outputs.nginx }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'auth-service/**'
            course:
              - 'course-service/**'
            learning:
              - 'learning-service/**'
            payment:
              - 'payment-service/**'
            nginx:
              - 'nginx/**'

  # Build and test auth-service
  auth-service:
    needs: changes
    if: ${{ needs.changes.outputs.auth == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: auth-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: auth-service/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present

      - name: Run tests
        run: npm test --if-present

      - name: Build Docker image
        run: docker build -t skillsync-auth-service:${{ github.sha }} .

  # Build and test course-service
  course-service:
    needs: changes
    if: ${{ needs.changes.outputs.course == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: course-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: course-service/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present

      - name: Run tests
        run: npm test --if-present

      - name: Build Docker image
        run: docker build -t skillsync-course-service:${{ github.sha }} .

  # Build and test learning-service
  learning-service:
    needs: changes
    if: ${{ needs.changes.outputs.learning == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: learning-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: learning-service/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present

      - name: Run tests
        run: npm test --if-present

      - name: Build Docker image
        run: docker build -t skillsync-learning-service:${{ github.sha }} .

  # Build and test payment-service
  payment-service:
    needs: changes
    if: ${{ needs.changes.outputs.payment == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: payment-service
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: payment-service/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint --if-present

      - name: Run tests
        run: npm test --if-present

      - name: Build Docker image
        run: docker build -t skillsync-payment-service:${{ github.sha }} .

  # Build nginx
  nginx:
    needs: changes
    if: ${{ needs.changes.outputs.nginx == 'true' || github.event_name == 'push' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t skillsync-nginx:${{ github.sha }} ./nginx

  # Docker Compose validation
  docker-compose-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate docker-compose.yml
        run: docker compose config --quiet

  # Final status check
  ci-status:
    needs: [auth-service, course-service, learning-service, payment-service, nginx, docker-compose-validation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Check CI Status
        run: |
          if [[ "${{ needs.auth-service.result }}" == "failure" ]] || \
             [[ "${{ needs.course-service.result }}" == "failure" ]] || \
             [[ "${{ needs.learning-service.result }}" == "failure" ]] || \
             [[ "${{ needs.payment-service.result }}" == "failure" ]] || \
             [[ "${{ needs.nginx.result }}" == "failure" ]] || \
             [[ "${{ needs.docker-compose-validation.result }}" == "failure" ]]; then
            echo "CI Pipeline failed"
            exit 1
          fi
          echo "CI Pipeline passed"
